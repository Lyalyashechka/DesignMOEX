# Московская биржа 
## 1. Тема и целевая аудитория.
### 1.1 Тема.
   Московская биржа является крупнейшим организатором торгов акциями, облигациями и другими активами в России. По [данным](https://bcs-express.ru/novosti-i-analitika/top-10-mirovykh-birzh) на июль 2018г. Мос. биржа занимает 22 из 81 место среди крупнейших бирж мира. 
   
   |MVP|
   |---|
   |1. Получение актуальной котировки по паре|
   |2. Получение информации о стакане|
   |3. Оформление ордера на рынке| 
   |4. Получение истории торгов по паре|  
   
### 1.2 Целевая аудитория.
**По [данным](https://www.moex.com/ru/members.aspx?tid=1179&sby=4) на январь 2022 года количество уникальных клиентов Мос. Биржи:**  
|Тип аудитории      |Кол-во человек|
|-------------------|------------|
|1. Физические лица | 16 779 069 |
|2. Юридические лица | 20 446 |
|3. Иностранные лица | 23 517 |
|4. Иностранные физические лица | 20 685 |
|5. Иностранные юридические лица|  2 832 |
|6. Клиенты, передавшие свои средства в ДУ| 327 432 |
|7. Всего| 17 150 464|  
 
## 2. Расчет нагрузки. 
### 2.1 Продуктовые метрики.  
   **2.1.1. Месячная аудитория.**  
   Количество людей, совершивших хотя бы одну сделку в месяц: 2 723 661. [(источник)](https://www.moex.com/ru/members.aspx?tid=1179&sby=4). Но так же в систему обращаются пользователи, которые заходят на биржу чтобы посмотреть стоимость своих активов, узнать актуальные котировки. По [данным](https://www.gazeta.ru/social/2021/07/06/13705718.shtml) 60% брокерских счетов остаются пустыми, сделаем предположение, что остальные 40% пользователей хотя бы раз в месяц делают тот или иной запрос в систему, еще предположим что пятая часть пользователей с пустыми брокерскими кошельками используют сервис хотя бы раз в месяц для просмотра котировок и тогда примерная общая месячная аудитория ```17 150 464 * 0,4 + 17 150 464 * 0,12 = 8 918 235```.

   **2.1.2. Примерная ежедневная аудитория.**  
Торговля на бирже осуществляется с помощью брокеров. Для подсчета ежедневной аудиторией воспользуемся [данными брокера втб](https://www.vtb.ru/o-banke/press-centr/novosti-i-press-relizy/2021/04/2021-04-20-obem-sredstv-pod-upravleniem-vtb-kapital-investitsii-v-i-kvartale-vyros-na-107/#) о количестве уникальных пользователей, ежедневно использующих их мобильное приложение ``` По состоянию на апрель 2021 года - 300 000 человек``` и [данными](https://smart-lab.ru/brokers-rating/russia/stat/) о распределении общего объема пользователей, совершивших хотя бы одну сделку, по брокерам:  
  
![image](https://user-images.githubusercontent.com/77728314/167299298-f57c1b43-4b20-4ede-b8e6-bb2c2746ca67.png)  
  
Предположим, что рост активных пользователей приложения ВТБ был согласно этому графику, тогда с апреля по ноябрь он составил ~30% и ежедневная аудитория составляет ``` 300 000 * 1,3 = 390 000 ```.  
Исходя из графика пользователи ВТБ занимают 14% от общего объема пользователей на мосбирже. Тогда ежедневная аудитория мос.биржи примерно равна ```390 000 / 14 * 100 = 2 785 000``` пользователей.  
  
   **2.1.3. Среднее количество действий пользователя по типам в день**  
   +  **Оформление сделки**  
   Согласно [данным](https://www.moex.com/ru/marketdata/#/mode=groups&group=4&collection=3&boardgroup=57&data_type=history&date=2022-01-19&category=main) среднее количество сделок по парам в январе 2022г. ~3 400 000. Это в примерно 2 раза больше чем на [январь 2021 года](https://www.moex.com/ru/marketdata/#/mode=groups&group=4&collection=3&boardgroup=57&data_type=history&date=2022-01-19&category=main),что соответствует росту количества физических лиц, пользующихся сервисом, в 2 раза за год. Тогда среднее количество сделок на пользователя в день - ```3 400 000/ 2 785 000 = 1,22```. Предположим, что количество отмененных ордеров в 2 раза больше, чем совершенных сделок, тогда пользователь в среднем оформляет ```1,22 * 3 = 3,66``` ордера в сутки. 
   + **Получение данных о стакане**  
   Возьмем среднее время сессии пользователя с самой популярной биржи цифровых активов binance.com [00:08:48](https://www.similarweb.com/ru/website/binance.com/#overview) (binance - аналогичный сервис, но торговля в нем происходит без участия брокеров). И предположим что пользователь из этого времени 2 минуты наблюдает за стаканом, тогда он за 2 минуты отправит ```240``` запросов:  
   
   + **Получение текущей котировки**  
   На основе все того же среднего времени пребывания на бирже пользователя (00:08:48) сделаем предположение, что 5 минут пользователь отправляет запросы на получение текущей котировки того или иного актива и так же предположим, что запрос на обновление отправляется раз в пол секунды. Тогда в день пользователь выполнит:``` 2 * 60 * 5 = 600 ``` запросов.  
  
   + **Получение истории торгов по паре**  
   Также предположим что в среднем пользователь тратит 1 минуту пребывания в приложении на просмотр истории торгов по какой-либо паре. И страница истории обновляется также раз в пол секунды, тогда пользователь выполнит: ```2 * 60 * 1 = 120``` запросов. 
   
   
   |Тип действия | Количество в день| 
   |-------------|------------------|
   |Оформление ордера| 3.66| 
   |Получение данных о стакане|240|
   |Получение текущей котировки|600|  
   |Получение истории торгов по паре|120|  
   
   **2.1.4. Средний размер хранилища пользователя**   
   Торговля на бирже осуществляется с помощью посредников - брокеров. Именно они хранят всю информацию о пользователях (количество активов, историю торгов, персональные данные). 

### 2.2 Технические метрики.   
   **2.2.1 Размер хранения в разбивки по типам данных**  
   * Информация о сделках пользователей:  
Примерный вид одной сделки в БД:  

|id ордера|Пара|Тип_ордера_1|Тип_ордера_2|Количество|Время|Цена|Стоп цена|Статус|
|---------|----|-------------------------|---------------------------|----------|-----|----|---------|------|
|BIGINT   |INT    |ENUM                  | ENUM                      |NUMERIC(12,2)   |DATE |NUMERIC(13,6)|NUMERIC(13,6)|ENUM|
|8 байт   |4 байта|4 байта               | 4 байта                   | 8 байт  |8 байт|8 байт |8 байт|4 байта|  

В итоге размер одной сделки составляет ```56 байт```.


Пояснения к полям таблицы:  
* Тип_ордера_1 ENUM("buy","sell) - предположим, что сделка была совершена на торговой паре RUB/SBER, тогда buy или sell означают что актив SBER был продан или куплен за актив RUB.  
* Тип_ордера_2 ENUM("market", "limit", "stop-order") - указывает на то, какие ограничения накладываются на ордер, например, в случае "limit", ордер будет исполнен только в случае, если будет достигнута указанная цена. 
* Статус ENUM("done","cancel","progress")  

Оценим примерно сколько информации о сделках хранится на бирже:  
На бирже можно получить историю торгов с 2009 года. Посмотрим на количество пользователей в эти года.  
  
![image](https://user-images.githubusercontent.com/77728314/167309682-30297b57-6744-4b3a-b73f-62fc8c837e88.png)
  
Предположим, что количество пользователей росло пропорционально количеству сделок.  
Тогда ```16 000 000 / 3 400 000 = 417 000 / x, где x - ежедневное количество сделок, совершаемыми пользователями за 2009 год; x =  142 500```  
Подобным образом вычислим "x" для каждого года, начиная с 2009:  
|2009|2010|2011|2012|2013|2014|2015|2016|2017|2018|2019|2020|2021|
|----|----|----|----|----|----|----|----|----|----|----|----|----|
|142 500|151 700|164 000|171 000|187 000|200 000|214 000|234 000|278 000|415 500|652 000|1 700 000|3 400 000|  

Просуммируем полученные значения и умножим на среднее количество рабочих дней в году(247). 
Общее количество сделок на бирже с 2009 года: ```1 953 695 900```.  
   
Тогда биржа должна хранить:    
   ```56 байт * 1 953 695 900 = 109,17 Гб``` 
   
   Также биржа должна хранить информацию о торгах, для построения графиков.  
   По [данным](https://www.moex.com/ru/listing/securities.aspx) на январь 2022г на бирже торгуется 3625 активов. Биржа постоянно проводит листинг новых бумаг и удаляет другие, однако по данным из этого же источника в 2014 году на бирже торговалось 3675 активов, будем считать что в среднем на бирже торгуется 3650 активов. Также в среднем биржа предоставляет данные по истории торгов начиная с 2008 года. Минимальный масштаб графика - 1 минута. Для отображения линейного графика нужна средняя цена за эту минуту, а для отображения графика "японские свечи" нужна минимальная и максимальная цена за эту минуту. Таким образом можно сделать предположение, что таблица выглядит так:  
   
   |id актива|Дата|Средний прайс|Мин. прайс|Макс. прайс| 
   |---------|----|-------------|----------|-----------|
   |INT      |DATETIME|NUMERIC(13,6)     |NUMERIC(13,6)    |NUMERIC(13,6)      | 
   |4 байта  |8 байт  |8 байт   |8байт     |8 байт     |  
   
   До 20 июня 2020г. торги на бирже проводились с 10:00 до 18:40 по московскому времени, с 20 июня с 10:00 до 23:50, а с 1 марта 2021 с 7:00 до 23:50. Посчитаем какое количество информации хранит биржа об истории торгов активами с 1 января 2009г. по 1 января 2022г:  
   * 01.01.2009 - 20.06.2020: ```(247 * 11 + 110) * 520 * 3650 * 36 байт = 193 163 256 000 байт  (11 - количество лет с 2009 по 2020, 110 количество рабочих дней до 20.06.2020, 520 - количество минут в рабочем дне``` 
   * 20.06.20 - 01.03.2021 ```(137 + 34) * 830 * 3650 * 36 байт = 18 649 602 000 байт```  
   * 01.03.2021 - 01.01.2022 ```213 * 1010 * 3650 * 36 байт = 28 268 082 000 байт```  
  
   Общее количество информации о торгах: ```240 080 940 000 байт = 224,3 Гб```  
   
   **2.2.2. Сетевой трафик**  
   ***2.2.2.1. Пиковое потребление в течении суток***  
   Исходя из котировок биржи основной объем торгов приходится на момент времени с 10:00 до 11:00 (в данный момент в это время происходит открытие торгов):  
   ![image](https://user-images.githubusercontent.com/77728314/167316052-ac4f923a-161e-4b12-9a14-0dbceccba066.png)
  
   Довольно часто на этот период приходится 25 процентов всех дневных торгов, более того в первые 15 минут этого часа совершается 50 процентов объема торгов всего часа. Тогда предположим, что за эти 15 минут может совершаться 12,5 процентов всех дневных сделок на бирже т.е. ```3 400 000 * 0,125 = 425 000``` , учитывая что в среднем один пользователей совершает 1,22 сделки в день, то количество пользователей в этот момент ``` 425 000 / 1,22 = 348 360```.  
   
   * Получение истории торгов  

Как уже отмечалось ранее: самый популярный актив на момент января 2021 - акции Сбербанка, если за эти 15 минут совершиться 12,5 процентов сделок по бумаге Сбербанка т.е ```500 000 * 0,125 = 62 500```, то за 1 минуту пребывания на данной паре, пользователь в среднем получит ```62 500 / 15 = 4 166``` сообщения об обновлении стакана. Исходя из изложенного выше максимум нагрузки возможен если все 348 360 пользователей в один момент будут наблюдать за стаканом на паре Сбербанка. Однако, если все пользователи будут наблюдать за историей сделок, то кто тогда будет совершать сделки. Предположим что в какую-то минуту пользователи получат 200 000 раз по 4166 сообщения о сделках. 
    
   Для истории сделок по сети передается следующая информация:  
   
   |Пара|Тип_ордера_1|Тип_ордера_2|Количество|Время|Цена|
   |----|-------------------------|---------------------------|----------|-----|----|
   |INT    |ENUM                  | ENUM                      |NUMERIC(12,2)   |DATE |NUMERIC(13,6)|
   |4 байта|4 байта               | 4 байта                   | 8 байт  |8 байт|8 байт |
   
   Всего: 40 байт. 
   
   Тогда пиковое потребление трафика для получения истории торгов: 200 000 * 4166 * 40 байт / 60 сек = 4,44 Гбит/с
   
   * Обновление стакана  
   
   Предположим, что количество ордеров, созданных в первые 15 минут торгов в 3 раза больше, чем количество совершенных сделок, тогда всего будет создано 62 500 * 3 = 187 500 ордеров. Аналогично предположим, что в какой то момент времени 200 000 пользователей будут получать 187 500 / 15 = 12500 сообщений об обновлении стакана. 
   Для отображения одного ордера в стакане по сети передается следующая информация:  
   
   |Тип ордера (buy или sell)|Количество|Цена|
   |-------------------------|----------|----|
   |ENUM                     |FLOAT64   |FLOAT64|
   |4 байта                  | 8 байт  |8 байт |  
   
   Всего: 20 байт.
   
   Тогда пиковое потребление трафика для информации о стакане: 200 000 * 12 500 * 20 байт / 60 сек = 6,67 Гбит/с
   
   * Оформление ордера  
   
   Для оформление ордера по сети передается следующая информация:  
   
   |Пара|Тип_ордера_1|Тип_ордера_2|Количество|Цена|Стоп цена|
   |----|-------------------------|---------------------------|----------|----|---------|
   |INT    |ENUM                  | ENUM                      |NUMERIC(12,2)   |NUMERIC(13,6)|NUMERIC(13,6)|
   |4 байта|4 байта               | 4 байта                   | 8 байт  |8 байт |8 байт|  
   
   Всего: 36 байт. 
   
   Исходя из рассчитанного выше в какую то минуту будет оформлено 12 500 и по сети будет передана информации: 12 500 * 36 = 3,6 Мбит/с
   
   * Получение актуальной котировки по паре

   Для получения актуальной котировки по паре по сети передается следующая информация:  
   |Пара|Цена| 
   |----|----|
   |INT |NUMERIC(13,6)|
   |4 байта|8 байт| 
   
   Всего: 12 байт 
   
   При пиковой нагрузке у нас возможно 348 360 пользователей и пусть каждый из них на протяжении минуты раз в полсекунды получает актуальную информацию о цене пары. Тогда по сети будет передано: 348 360 * 2 * 12 байт / 1с = 66,7 Мбит/с  
   
|Тип трафика| Пиковая нагрузка| 
|-----------|-----------------|
|1. Получение истории торгов | 4,44 Гбит/с|
|2. Обновление стакана| 6,67 Гбит/с| 
|3. Оформление ордера|3,6 Мбит/с|
|4. Получение актуальной котировки по паре|66,7 Мбит/с|  

```
Грубо предположим, что максимальная нагрузка равна 6,67 + 4 = 10,67 Гбит/с т.к. из рассчета того что большинство пользователей будут наблюдать за стаканом, меньше пользователей за историей торгов и оставшаяся часть совершать сделки на самой популярной паре. 
```  

   ***2.2.2.2. Суммарный суточный***  
     
   * Суточный трафик по просмотру истории торгов: 2 785 000 * 120 * 10 * 40 байт = 133 ГБ/сутки (10 - грубо предположим, что пользователь получает в среднем информацию о 10 сделках за 1 запрос).
   * Суточный трафик по просмотру текущих ордеров в стакане: 2 785 000 * 240 * 30 * 20 байт = 401,4 ГБ/сутки (30 - предположение того, что отмененных ордеров в 2 раза больше чем сделок).  
   * Суточный трафик по оформлению ордеров: 2 785 000 * 1,22 * 3 * 36 байт = 0,36 ГБ/сутки.  
   * Суточный трафик по просмотру текущей котировки: 2 785 000* 600 * 12 = 20 ГБ/сутки. 
    
   **2.2.3. RPS в разбивке по типам запросов**  
   * Количество запросов в сутки на просмотр истории торговли: 2 785 000 * 120 = 334 200 000.  
   * Количество запросов в сутки на получение данных из стакана:      2 785 000 * 240 = 668 400 000.  
   * Количество запросов в сутки на оформление ордера:                2 785 000 * 3,66 = 10 193 100.  
   * Количество запросов в сутки на получение актуальной котировки по паре:  2 785 000 * 600 = 1 671 000 000.
   
   Для получения RPS делим эти данные на (17 * 60 * 60).  
      
   |Тип запроса | RPS|
   |------------|----|
   |Просмотр истории торговли| 5 461|
   |Получение данных из стакана     | 10 921|
   |Оформление ордера               | 167|
   |Получение актуальной котировки по паре|27 303|
      
   RPS при пиковом трафике:  ```348 360 * 2 = 696 720 (2 - константа, с которой обновляются все данные биржи)```  
## 3. Логическая схема.  
![Highload_3](https://user-images.githubusercontent.com/77728314/168273365-628eefa2-9d45-4c26-b3a1-d31ba522be46.jpg)

## 4. Физическая схема.  
  ![hihgload_physic](https://user-images.githubusercontent.com/77728314/168273391-f27e107e-e9b6-49c3-8df5-f1964a1834b7.jpg)

  ***4.1. Индексы.***  
  orders - индексы по user_id; (trade_pare_id, time)  
  trade_history - индекс (id_trade_pare, time)  
  
   ***4.2. Шардирование.***  
  Как отмечалось выше на бирже торгуется 3650 ценных бумаг. Таблицу с временными рядами и таблицу orders можно шардировать по id_trade_pare. Таким образом мы существенно ускорим получение истории торговли и списка сделок.  
  Виртуальные шарды будем мапить на сервера по следующему принципу:  
  На бирже все активы делятся на 3 уровня по доверенности биржи к этим активам. Подавляющий объем торгов приходится на активы 1 уровня, таких активов 776, их будем мапить по 8 виртуальных шардов на 1 физический сервер. Оставшиеся 3 000 будем мапить по 100 на один физ. сервер.  
## 5. Технологии.  
|Технология|Область применения|Мотивационная часть| 
|----------|------------------|-------------------|
|PostgreSql|Таблицы пользователей, активов, торговых пар| Данный сегмент данных не подвержен частым изменениям, в качестве базы данных было выбрано наиболее популярное и развитое решение среди открытых СУБД. Также возможность хранить в postgreSQL объекты может быть очень полезна для хранения специфических данных об активе или пользователе.| 
|InfluxDB|Таблица с временными рядами торговых пар| Influx новое решение с открытым исходным кодом, специализирующееся на хранение временных рядов. Оно имеет высокую пропускную способность для поступающих данных, позволяет выполнять сжатие и запрашивать эти же самые данные в реальном времени. InfluxDB была разработана с самого начала, с целью обеспечить высокомасштабируемый механизм приема и хранения данных. Он очень эффективен при сборе, хранении, запросе, визуализации и выполнении действий с потоками данных временных рядов, событий и метрик в реальном времени.|  
|MemSQL|Таблицы ордеров, активов пользователя| MemSQL позиционирует себе как новый класс БД HTAP (Hybrid transactional / analytical processing). MemSQL обходит узкое место ввода-вывода большинства алтернативных БД, помещая данные в память и переводя SQL на C++, что позволяет базе данных отправлять больше транзакций в секунду с чрезвычайно низкой задержкой (<1 мс на запрос). MemSQL совместим с MySQL и для работы с ним можно использовать те же инструменты и драйверы, что и для MySQL. Также одним из преимуществ MemSQL является предоставление аналитики в режиме реального времени.|  
|JAVA|Основной ЯП системы|На данный момент JAVA это баланс между временем на разработку, качеством, вычислительной точностью и скоростью работы. На JAVE написано огромное количество коммерческих программ, в том числе с высокой нагрузкой. Регулярные обновления, возможность сохранения обратной совместимости между версиями и многолетняя положительная репутация позволяют выбрать JAVA в качестве основного ЯП.|  
## 6. Схема проекта. 
![Untitled Diagram (9)](https://user-images.githubusercontent.com/77728314/167515689-eefe8afe-bc1d-4a38-8e74-9c8175db8abb.jpg)

На NGINX будет осуществляться L7 балансировка между серверами.  
Используем Nginx для балансировки нагрузки и в качестве reverse-proxy. В качестве алгоритма балансировки будем использовать round-robin так как он обеспечивает в среднем равномерную балансировку для неблокирующих соедениний.  

Сам проект состоит из 3 микросервисов:  
* *history_api* отвечает за отдачу пользователям временных рядов истории торговли.  
* *simple_data_api* отвечает за регистрацию новых пользователей, просмотр и добавление торговых пар и активов.  
* *trade_api* отвечает за оформление и просмотр ордеров на рынках.  

После создания или обновления ордера в MemSQL бд происходит перерасчет значений в Influx бд.  

## 7. Список серверов.
* NGINX   
В среднем NGINX выдает 300 RPS на 1 ядро.  
Возьмем 64 ядерные процессоры, тогда при пиковой нагрузке нам необходимо ```696 720 / (300 * 64) = 37 ``` серверов.  
* trade_api  
Самый нагруженный сервер. Исходя из собственных тестов на 4 ядерном процессоре java spring сервер способен выдавать 2700 rps (запросы с 1 походом в базу данных), исходя из этих данных предположим, что 64 ядерный процессор способен выдавать 43 200 rps, тогда при пиковой нагрузке нам нужно ```696 720 / 43 200 = 16``` таких серверов.  
* history_api  
Нагрузка на этот сервер существенно ниже чем на trade_api. Предположим, что в пике 348 360 пользователей будут смотреть график истории торгов одновременно, посылая запрос на получение данных о следующей порции временных рядов раз в 2 секунды, тогда количество RPS = 174 180. Количество серверов ```174 180 / 43 200 = 4``` 
* simple_data_api  
Самый ненагруженный сервер, предположим, что в пике на него будет приходится 80 000 RPS, тогда нам понадобится ```2``` сервера.  
* InflexDB  
Исходя из пункта 4.2 нам понадобится ``` 800 / 8 + 3 000 / 100 = 130``` серверов. Размер истории торгов для 1 пары достаточно маленький и нам с запасом хватит 64Гб RAM и SSD на 64Гб для каждого из них.  
* MemSQL  
Нам также понадобится 130 серверов и нам также с запасом хватит 64Гб RAM и SSD на 64Гб.  
* PostgreSQL  
Хранит информацию о ~30 000 000 млн пользователей и 4 000 активах и парах. Это примерно ```30 000 000 * 465 байт + 8 000 * 200 байт = ~15Гб```. Хватит 1 сервера

Все сервера для api и балансировки будем брать x2 с запасом по мощности, и x2 для сервером БД для реплик.  
|Сервис	|CPU (ядер)|	RAM (ГБ)	|Диск(Гб	|Количество|  
|--------|----------|------------|-----|----------|  
|NGINX   |64        |64          |SSD 64|37 + 37 |
|trade_api|64        |64         |SSD 64|16 + 16  |
|history_api|64      |64         |SSD 64|4 + 4     |
|simple_data_api|64| 64          |SSD 64|2 + 2| 
|InflexDB        |32|64          |SSD 64|130 +130 |
|MemSQL          |32|64          |SSD 64|130 +130 |
|PostgreSQL      |32|64          |SSD 64|1 + 1|  

## Источники информации. 
1. https://bcs-express.ru/novosti-i-analitika/top-10-mirovykh-birzh
2. https://www.moex.com/ru/members.aspx?tid=1179&sby=4
3. https://vc.ru/tinkoff_invest/216367-tinkoff-investicii-sostavili-portret-rossiyskogo-investora-2020
4. https://www.vtb.ru/o-banke/press-centr/novosti-i-press-relizy/2021/04/2021-04-20-obem-sredstv-pod-upravleniem-vtb-kapital-investitsii-v-i-kvartale-vyros-na-107/#
5. https://smart-lab.ru/brokers-rating/russia/stat/
6. https://www.moex.com/ru/marketdata/#/mode=groups&group=4&collection=3&boardgroup=57&data_type=history&date=2022-01-19&category=main
7. https://www.similarweb.com/ru/website/binance.com/#overview 
8. https://www.tinkoff.ru/about/news/14022020-tinkoff-investments-research-retail-investor-portrait/
