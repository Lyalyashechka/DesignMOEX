# Московская биржа 
## 1. Тема и целевая аудитория.
### 1.1 Тема.
   Московская биржа является крупнейшим организатором торгов акциями, облигациями и другими активами в России. По [данным](https://bcs-express.ru/novosti-i-analitika/top-10-mirovykh-birzh) на июль 2018г. Мос. биржа занимает 22 из 81 место среди крупнейших бирж мира. 
   
   |MVP|
   |---|
   |1. Отслеживание ситуации на рынке| 
   |2. Осуществление сделки на рынке| 
   |3. Получение своей истории торгов на рынке| 
### 1.2 Целевая аудитория.
**По [данным](https://www.moex.com/ru/members.aspx?tid=1179&sby=4) на январь 2022 года количество уникальных клиентов Мос. Биржи:**  
|Тип аудитории      |Кол-во человек|
|-------------------|------------|
|1. Физические лица | 16 779 069 |
|2. Юридические лица | 20 446 |
|3. Иностранные лица | 23 517 |
|4. Иностранные физические лица | 20 685 |
|5. Иностранные юридические лица|  2 832 |
|6. Клиенты, передавшие свои средства в ДУ| 327 432 |
|7. Всего| 17 150 464|  
  
**Основная целевая аудитория** - физические лица, россияне.  
**Портрет российского инвестора согласно сервису** «[Тинькофф инвестиции](https://vc.ru/tinkoff_invest/216367-tinkoff-investicii-sostavili-portret-rossiyskogo-investora-2020)»:  
   |Пол|%|
   |-------|--|
   |Мужчины        |69 %|
   |Женщины        |31 %|  
     
   |Средний возраст|%| 
   |---------------|--|
   |28-38 лет      |43 %|
   |18-28 лет      |27 %|
   |38-48 лет      |21 %|
   |48+            |9  %|  
   
 
## 2. Рассчет нагрузки. 
### 2.1 Продуктовые метрики.  
   **2.1.1. Месячная аудитория.**  
   Количество людей, совершивших хотя бы одну сделку в месяц: 2 723 661. [(источник)](https://www.moex.com/ru/members.aspx?tid=1179&sby=4)  

   **2.1.2. Примерная ежедневная аудитория.**  
Торговля на бирже осуществляется с помощью брокеров. Для подсчета ежедневной аудиторией воспользуемся [данными брокера втб](https://www.vtb.ru/o-banke/press-centr/novosti-i-press-relizy/2021/04/2021-04-20-obem-sredstv-pod-upravleniem-vtb-kapital-investitsii-v-i-kvartale-vyros-na-107/#) о количестве уникальных пользователей, ежедневно использующих их мобильное приложение ``` По состоянию на апрель 2021 года - 300 000 человек``` и [данными](https://smart-lab.ru/brokers-rating/russia/stat/) о распределении общего объема пользователей, совершивших хотя бы одну сделку, по брокерам:  
  
![image](https://user-images.githubusercontent.com/77728314/167299298-f57c1b43-4b20-4ede-b8e6-bb2c2746ca67.png)  
  
Предположим, что рост активных пользователей приложения ВТБ был согласно этому графику, тогда с апреля по ноябрь он составил ~30% и ежедневная аудитория составляет ``` 300 000 * 1,3 = 390 000 ```.  
Исходя из графика пользователи ВТБ занимают 14% от общего объема пользователей на мосбирже. Тогда ежедневная аудитория мос.биржи примерно равна ```390 000 / 14 * 100 = 2 785 000``` пользователей.  
  
   **2.1.3. Среднее количество действий пользователя по типам в день**  
   +  **Оформление сделки**  
   Согласно [данным](https://www.moex.com/ru/marketdata/#/mode=groups&group=4&collection=3&boardgroup=57&data_type=history&date=2022-01-19&category=main) среднее количество сделок по парам в январе 2022г. ~3 400 000. Это в примерно 2 раза больше чем на [январь 2021 года](https://www.moex.com/ru/marketdata/#/mode=groups&group=4&collection=3&boardgroup=57&data_type=history&date=2022-01-19&category=main),что соответствует росту количества физических лиц, пользующихся сервисом, в 2 раза за год. Тогда среднее количество сделок на пользователя в день - ```3 400 000/ 2 785 000 = 1,22```
   + **Получение своей истории торгов**  
   Ежедневное количество пользователей биржи 2 785 000, предположим что каждый из них хотя бы раз в среднем сделает запрос на получение 30 своих последних ордеров.  
   + **Отслеживание ситуации в стакане**  
   Возьмем среднее время сессии пользователя с самой популярной биржи цифровых активов binance.com [00:08:48](https://www.similarweb.com/ru/website/binance.com/#overview) (binance - аналогичный сервис, но торговля в нем происходит без участия брокеров). И предположим что пользователь из этого времени 8 минут наблядает за стаканом на самом популярном рынке (исходя из данных в п 2.1.3. такой рынок - SBER с 500 000 сделок за торговый день). Сделаем рассчет количества сделок, информацию о которых пользователя получет за указанное время (при пиковой нагрузке, когда торговля происходит очень быстро, ордер попавший в поле видимости стакана обычного пользователя с большой вероятностью окажется исполненным и превратиться в законченную сделку):  
   ```
 500 000 / 17 / 60 * 8 = 3 921 (17 - количество рабочих часов биржи в сутки)
   ```
   |Тип действия | Количество в день| 
   |-------------|------------------|
   |Оформление сделки| 1.22|
   |Получение истории торгов| 1|
   |Отслеживание ситуации в стакане|3 921|  
   
   **2.1.4. Средний размер хранилища пользователя**   
   Биржа должна хранить информацию о пользователе, осуществляющем торговлю.
   В открытом доступе не удалось узнать какую информацию хранит биржа о пользователе. Но исходя из регистрации сделаем такое предположение:  
   |id пользователя|ФИО|Адрес|Телефон|Адрес электронной почты|Серия и номер паспорта|
   |---------------|---|-----|-------|-----------------------|----------------------|
   |INT            |CHAR(100)|CHAR(300)|(CHAR(14)|CHAR(40)|CHAR(11)|
   |4 байта        |100 байт|300 байт|14 байт|40 байт|11 байт|  
   
   Размер информации о пользователе: ```465 байт```.
   
   Также биржа должна хранить историю торгов одного пользователя.  
Примерный вид одного ордера:  

|id ордера|id пользователя|Пара|Тип ордера (buy или sell)|Тип ордера(LIMIT, MARKET..)|Количество|Время|Цена|Стоп цена|Статус|
|---------|---------------|----|-------------------------|---------------------------|----------|-----|----|---------|------|
|BIGINT      |INT         |INT    |ENUM                  | ENUM                      |FLOAT64   |DATE |FLOAT64|FLOAT64|ENUM|
|8 байт  |4 байта         |4 байта|4 байта               | 4 байта                   | 8 байт  |8 байт|8 байт |8 байт|4 байта|
  
В итоге размер одной сделки в байтах составляет ```60 байт```.

Оценим примерно сколько в среднем сделок хранится у одного пользователя:  
На бирже можно получить историю торгов с 2009 года. Посмотрим на количество пользователей в эти года.  
  
![image](https://user-images.githubusercontent.com/77728314/167309682-30297b57-6744-4b3a-b73f-62fc8c837e88.png)
  
Предположим, что количество пользователей росло пропорционально количеству сделок (подобную закономерность косвенно подтвердили выше).  
Тогда ```16 000 000 / 3 400 000 = 417 000 / x, где x - ежедневное количество сделок, совершаемыми пользователями за 2009 год; x =  142 500```  
Подобным образом вычислим "x" для каждого года, начиная с 2009:  
|2009|2010|2011|2012|2013|2014|2015|2016|2017|2018|2019|2020|2021|
|----|----|----|----|----|----|----|----|----|----|----|----|----|
|142 500|151 700|164 000|171 000|187 000|200 000|214 000|234 000|278 000|415 500|652 000|1 700 000|3 400 000|  

Просуммируем полученные значения и умножим на среднее количество рабочих дней в году(247). 
Общее количество сделок на бирже с 2009 года: ```1 953 695 900```.  

Кроме этого биржа должна хранить информацию о количестве активов у пользователя:  
|id пользователя|id актива|Количество| 
|---------------|---------|----------|
|INT            |INT      |INT       |
|4 байта        |4 байта  |4 байта   |  

По [данным](https://www.tinkoff.ru/about/news/14022020-tinkoff-investments-research-retail-investor-portrait/) Тинькофф инвестиций - в среднем у одного пользователя 11 акций в портфеле.  
Тогда на количество активов пользователя приходится ``` 4 * 3 * 11 = 132 байта ``` 
```
В среднем размер хранилища одного пользователя:  1 953 695 900 / 16 779 069 * 60 байт + 465 байт + 132 байта = ~7,405 Кб.
```

### 2.2 Технические метрики.   
   **2.2.1 Размер хранения в разбивки по типам данных**  
   Информция о пользователях: ```465 байт * 27 657 626 = 12 860 796 090 байт = 11,98 Гб```  ([информация о количестве аккаунтов физ.лиц](https://www.moex.com/ru/members.aspx?tid=1179&sby=4))  
   
   Информация о сделках пользователей: ```60 байт * 1 953 695 900 = 109,17 Гб``` 
   
   Также биржа должна хранить информацию о торгах, для построения графиков.  
   По [данным](https://www.moex.com/ru/listing/securities.aspx) на январь 2022г на бирже торгуется 3625 активов. Биржа постоянно проводит листинг новых бумаг и удаляет другие, однако по данным из этого же источника в 2014 году на бирже торговалось 3675 активов, будем считать что в среднем на бирже торгуется 3650 активов. Также в среднем биржа предоставляет данные по истории торгов начиная с 2008 года. Минимальный масштаб графика - 1 минута. Для отображения линейного графика нужна средняя цена за эту минуту, а для отображения графика "японские свечи" нужна минимальная и максимальная цена за эту минуту. Таким образом можно сделать предположение, что таблица выглядит так:  
   
   |id актива|Дата|Средний прайс|Мин. прайс|Макс. прайс| 
   |---------|----|-------------|----------|-----------|
   |INT      |DATETIME|FLOAT     |FLOAT    |FLOAT      | 
   |4 байта  |8 байт  |8 байт   |8байт     |8 байт     |  
   
   До 20 июня 2020г. торги на бирже проводились с 10:00 до 18:40 по московскому времени, с 20 июня с 10:00 до 23:50, а с 1 марта 2021 с 7:00 до 23:50. Посчитаем какое количество информации хранит биржа об истории торгов активами с 1 января 2009г. по 1 января 2022г:  
   * 01.01.2009 - 20.06.2020: ```(247 * 11 + 110) * 520 * 3650 * 36 байт = 193 163 256 000 байт  (11 - количестов лет с 2009 по 2020, 110 количество рабочих дней до 20.06.2020, 520 - количество минут в рабочем дне``` 
   * 20.06.20 - 01.03.2021 ```(137 + 34) * 830 * 3650 * 36 байт = 18 649 602 000 байт```  
   * 01.03.2021 - 01.01.2022 ```213 * 1010 * 3650 * 36 байт = 28 268 082 000 байт```  
  
   Общее количество информации о торгах: ```240 080 940 000 байт = 224,3 Гб```  
   **2.2.2. Сетевой график**  
   ***2.2.2.1. Пиковое потребление в течении суток***  
   Исходя из катировок биржи основной объем торгов приходится на момент времени с 10:00 до 11:00 (в данный момент в это время происходит открытие торгов):  
   ![image](https://user-images.githubusercontent.com/77728314/167316052-ac4f923a-161e-4b12-9a14-0dbceccba066.png)
  
   Довольно часто на этот период приходится 25 процентов всех дневных торгов, более того в первые 15 минут этого часа совершается 50 процентов объема торгов всего часа. Тогда предположим, что за эти 15 минут может совершаться 12,5 процентов всех дневных сделок на бирже т.е. ```3 400 000 * 0,125 = 425 000``` , учитывая что в среднем один пользователей совершает 1,22 сделки в день, то количество пользователей в этот момент ``` 425 000 / 1,22 = 348 360```.  
   Как уже отмечалось раннее: самый популярный актив на момент января 2021 - акции Сбербанка, если за эти 15 минут совершиться 12,5 процентов сделок по бумаге Сбербанка т.е ```500 000 * 0,125 = 62 500```, то за 1 минуту пребывания на данной паре, пользователь в среднем получит ```62 500 / 15 = 4 166``` сообщения об обновлении стакана. Исходя из изложенного выше максимум нагрузки возможен если все 348 360 пользователей в один момент будут наблюдать за стаканом на паре Сбербанка. Однако, даже если часть пользователей в этот момент будут наблюдать за стаканом на другой паре, то нагрузка уменьшиться не существенно. 
    
   Для истории сделок по сети передается следующая информация:  
   
   |Пара|Тип ордера (buy или sell)|Тип ордера(LIMIT, MARKET..)|Количество|Время|Цена|Стоп цена|Статус|
   |----|-------------------------|---------------------------|----------|-----|----|---------|------|
   |СHAR    |ENUM                  | ENUM                      |FLOAT64   |DATE |FLOAT64|FLOAT64|ENUM|
   |16 байт|4 байта               | 4 байта                   | 8 байт  |8 байт|8 байт |8 байт|4 байта|  
   
   Всего: 60 байт. 
   
   Для отображения одного ордера в стакане по сети передается следующая информация:  
   
   |Тип ордера (buy или sell)|Количество|Цена|
   |-------------------------|----------|----|
   |ENUM                     |FLOAT64   |FLOAT64|
   |4 байта                  | 8 байт  |8 байт |  
   
   Всего: 20 байт.
   
   Для оформление сделки по сети передается следующая информация:  
   
   |Пара|Тип ордера (buy или sell)|Тип ордера(LIMIT, MARKET..)|Количество|Цена|Стоп цена|
   |----|-------------------------|---------------------------|----------|----|---------|
   |INT    |ENUM                  | ENUM                      |FLOAT64   |FLOAT64|FLOAT64|
   |4 байта|4 байта               | 4 байта                   | 8 байт  |8 байт |8 байт|  
   
   Всего: 36 байт. 
   ```
   Пиковый трафик по просмотру истории своих сделок: 348 360 * 60 байт * 30 = 627 048 000 байт/15мин = 680,39 Кб/с;
   (30 - количество ордеров, о которых получаем информацию)  
   Пиковый трафик по просмотру текущих сделок в стакане: 348 360 * 4 166 * 20 байт / 60 с  = 461 МБ/с  
   Пиковый трафик по оформлению сделок: 425 000 / 15 / 60 * 36 байт = 17 000 байт/с = 16,6Кб/с 
```  
```
Максимальная нагрузка примерно равна 462 МБ/с, остальными показателями можно пренебречь,  
с учетом того что все пользователи не могут одновременно наблюдать за стаканом и просматривать историю своих сделок.  
(при оформлении сделки возможно продолжать наблюдать за стаканом)
```

## Источники информации. 
1. https://bcs-express.ru/novosti-i-analitika/top-10-mirovykh-birzh
2. https://www.moex.com/ru/members.aspx?tid=1179&sby=4
3. https://vc.ru/tinkoff_invest/216367-tinkoff-investicii-sostavili-portret-rossiyskogo-investora-2020
4. https://www.similarweb.com/ru/website/binance.com/#overview
5. https://www.moex.com/ru/listing/securities.aspx
